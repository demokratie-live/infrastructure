# GitHub Copilot Instructions für Democracy Infrastructure

## Projektkontext

Du arbeitest am Infrastruktur-Monorepo für **Democracy Deutschland e.V.** mit Pulumi Infrastructure as Code, DigitalOcean als Cloud-Provider und umfassendem CI/CD-Setup.

## Architektur & Stack

### Technologien

- **IaC**: Pulumi mit TypeScript
- **Cloud**: DigitalOcean (Kubernetes, Load Balancer, VPC, Domains)
- **Container**: Kubernetes mit Kustomize-Manifesten
- **CI/CD**: GitHub Actions mit Security-First Ansatz
- **Package Manager**: pnpm mit Workspace-Setup
- **Code Quality**: ESLint, Prettier, Knip, Husky Git Hooks

### Workspace-Struktur

```
infrastructure/
├── democracy-foundation/    # Base-Infrastruktur (VPC, Domains, Firewalls)
├── democracy-platform/      # Platform-Ressourcen (Kubernetes, Load Balancer)
├── shared/                  # Gemeinsame Utilities und Monitoring
├── infrastructure-base/     # Legacy-Base-Komponenten
└── scripts/                 # CI/CD und Operations-Scripts
```

### Stack-Abhängigkeiten

1. **foundation** (Basis) → 2. **platform** (abhängig von foundation)

## Entwicklungsrichtlinien

### Pulumi-Komponenten

- Verwende `pulumi.ComponentResource` für wiederverwendbare Komponenten
- Implementiere Stack-Referenzen für Cross-Stack-Abhängigkeiten: `createFoundationReference()`
- Nutze bestehende Namenskonventionen: `democracy-<env>` für Cluster
- Setze Resource-Protection basierend auf Environment (`isProduction ? true : false`)

### TypeScript-Standards

- Strikte Typisierung: `strict: true, noImplicitAny: true`
- Nutze ES2020+ Features und ESModules (`"type": "module"`)
- Importiere shared utilities: `import { ... } from "../../shared/src/..."`
- Verwende `tsx` für direkte TypeScript-Ausführung ohne Build-Step

### DigitalOcean-Ressourcen

- **Cluster**: Node Pools je nach Environment (`s-4vcpu-8gb` prod, `s-2vcpu-4gb` dev)
- **Load Balancer**: Environment-spezifische Namen (`democracy-lb-<env>`)
- **VPC**: Verwende bestehende Foundation-VPC via Stack-Referenz
- **Projects**: Separate Projekte für Environments (`Team DEMOCRACY`, `Team DEMOCRACY Dev`)

### Sicherheitsstandards

- Alle Secrets via GitHub Secrets (`DIGITALOCEAN_TOKEN`, `PULUMI_ACCESS_TOKEN`)
- Dependency-Scanning mit `pnpm audit --audit-level=moderate`
- Infrastructure-Security mit Checkov-Regeln
- Secret-Scanning bei Git-Commits (Husky Hooks)

## Scripts & Workflows

### Verfügbare npm-Scripts

```bash
# Stack-Operations
pnpm foundation:preview|up|destroy
pnpm platform:preview|up|destroy

# Testing & Validation
pnpm test:all                    # Alle Tests
pnpm validate:mock               # Mock-Validation (CI-safe)
pnpm validate:live               # Live-Stack-Validation
pnpm validate:deployment         # Post-Deployment-Checks

# Health & Monitoring
pnpm health:check|full|dns|k8s   # Health-Checks
pnpm status:save                 # Infrastructure-Status-Report

# Code Quality
pnpm lint|lint:fix               # ESLint für alle Pakete
pnpm format|format:check         # Prettier
pnpm knip:ci                     # Dead-Code-Analysis
pnpm security:check|report       # Security-Validation
```

### CI/CD-Pipeline-Jobs

1. **security-scan**: TruffleHog, Checkov, Kubesec, Dependency-Audit
2. **validate-enhanced**: Code Quality, Performance, Infrastructure-Tests
3. **preview-foundation/platform**: Cost-Analysis und Preview für PRs
4. **deploy-foundation → deploy-platform**: Sequenzielle Deployments
5. **post-deployment-monitoring**: Health-Checks und Reporting
6. **rollback**: Automatisch bei Deployment-Fehlern

## Best Practices

### Code-Patterns

```typescript
// Stack-Referenz erstellen
import { createFoundationReference } from "../shared/src/stack-refs";
const foundation = createFoundationReference("production");
const vpcId = foundation.getOutput("vpcId");

// Monitoring exportieren
import { exportStackHealth } from "../../shared/src/monitoring";
export const stackHealth = exportStackHealth([cluster, loadBalancer]);

// Environment-basierte Konfiguration
const isProduction = pulumi.getStack() === "production";
const nodeCount = isProduction ? 5 : 2;
```

### Kubernetes-Manifeste

- Verwende Kustomize für Environment-spezifische Konfiguration
- Base-Manifeste in `kustomize/base/`, Overlays in `kustomize/overlays/`
- Build-Commands: `pnpm build:k8s:production|alpha|local`

### Git-Workflow

- Husky Pre-Commit Hooks führen automatisch Lint, Format, Type-Check aus
- Lint-staged optimiert Performance (nur staged files)
- Secret-Detection bei Commits
- Performance-Regression-Checks bei Code-Änderungen

## Troubleshooting

### Häufige Befehle

```bash
# Stack-Status prüfen
cd democracy-foundation && pulumi stack output
cd democracy-platform && pulumi stack output

# Deployment Health-Check
pnpm health:full

# Infrastructure-Status-Report
pnpm status:save

# CI-Pipeline lokal testen
pnpm ci:fast
```

### Stack-Recovery

```bash
# Bei Stack-Korruption
pulumi refresh
pulumi stack export > backup.json

# Rollback zu vorherigem State
pulumi history
# Implementierung folgt Pulumi-Rollback-Patterns
```

## Hints für Copilot

### Code-Generierung

- Priorisiere TypeScript-Typen und Interface-Definitionen
- Nutze bestehende Pulumi-Patterns aus `democracy-foundation` und `democracy-platform`
- Implementiere Environment-Checks für Resource-Protection
- Verwende shared utilities für Cross-Stack-Operations

### Testing & Validation

- Schlage `tsx`-basierte Testskripte vor (ohne Build-Step)
- Implementiere Mock-Tests für CI-Environment
- Nutze bestehende Health-Check-Patterns aus `scripts/`

### Dokumentation

- Aktualisiere `README.md` bei größeren Architektur-Änderungen
- Dokumentiere neue Scripts in `OPERATIONS.md`
- Führe Änderungen in entsprechenden `.md`-Dateien auf

Diese Instructions helfen Copilot dabei, kontextbezogene, sichere und projektkonforme Vorschläge für das Democracy Infrastructure-Projekt zu generieren.
