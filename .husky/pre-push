#!/usr/bin/env sh

echo "ğŸš€ Running pre-push checks..."

# Change to infrastructure directory
cd infrastructure

# Check if we're pushing to main or develop - run comprehensive tests
protected_branch='main\|develop'
current_branch=$(git rev-parse --abbrev-ref HEAD)

if echo "$current_branch" | grep -q "$protected_branch"; then
    echo "ğŸ›¡ï¸  Pushing to protected branch '$current_branch' - running full validation suite..."
    
    # Run comprehensive validation
    echo "ğŸ” Running comprehensive validation..."
    if ! pnpm validate:all:strict; then
        echo "âŒ Comprehensive validation failed!"
        echo "Please fix the issues before pushing to $current_branch"
        exit 1
    fi
    
    # Run tests
    echo "ğŸ§ª Running all tests..."
    if ! pnpm test:all; then
        echo "âŒ Tests failed!"
        echo "Please fix the failing tests before pushing to $current_branch"
        exit 1
    fi
    
    echo "âœ… All pre-push checks passed for protected branch!"
else
    echo "ğŸ“‹ Running quick validation for feature branch..."
    
    # Quick validation for feature branches
    if ! pnpm validate:mock; then
        echo "âŒ Basic validation failed!"
        echo "Please fix the issues before pushing"
        exit 1
    fi
    
    echo "âœ… Quick validation passed!"
fi

echo "ğŸ‰ Pre-push checks completed successfully!"
